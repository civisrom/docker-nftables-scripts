#!/usr/sbin/nft -f
#
# nftables конфиг: NAT-релей (сервер 1-ru)
#
# Схема маршрутизации:
#   Клиент → 1-ru:443  → DNAT → 2-ge:443   [VLESS/XRay]
#   Клиент → 1-ru:8443 → DNAT → 3-nl:443   [VLESS/XRay]
#   Клиент → 1-ru:4443 → DNAT → 2-ge:4443  [MTProto]
#   Клиент → 1-ru:4444 → DNAT → 3-nl:4443  [MTProto]
#
# Принцип работы:
#   1. Клиент подключается к 1-ru:PORT
#   2. PREROUTING DNAT подменяет destination на зарубежный сервер
#   3. FORWARD пропускает пакет (с ASN/GeoIP фильтрацией)
#   4. POSTROUTING MASQUERADE подменяет source на IP 1-ru
#   5. Зарубежный сервер видит подключение от 1-ru, не от клиента
#
# Трафик зашифрован end-to-end (TLS/WG), 1-ru не может расшифровать.
#
# Требования:
#   1. sysctl:
#      net.ipv4.ip_forward = 1
#   2. Рекомендуется:
#      net.core.default_qdisc = fq
#      net.ipv4.tcp_congestion_control = bbr

# Очищаем существующие правила
flush ruleset

# ─── Серверы назначения ──────────────────────────────────────────────
# Сервер 1-ru — это текущий хост (11.11.11.11)
define SERVER_GE    = 22.22.22.22
define SERVER_NL    = 33.33.33.33

# ─── Порты релея ─────────────────────────────────────────────────────
# VLESS/XRay: TCP 443
# Каждый зарубежный сервер слушает на своём порту,
# на 1-ru используем РАЗНЫЕ входные порты чтобы различать куда форвардить.
#
# Порт 443 → 2-ge (основной VLESS)
define GE_TCP_PORT  = 443
# Порт 8443 → 3-nl (второй VLESS, другой входной порт на 1-ru)
define NL_TCP_PORT  = 8443

# MTProto: TCP 4443
# Порт 4443 → 2-ge (MTProto)
define GE_MTPROTO_PORT = 4443
# Порт 4444 → 3-nl (MTProto, другой входной порт на 1-ru)
define NL_MTPROTO_PORT = 4444

# ── AmneziaWG / WireGuard: UDP (раскомментировать при необходимости) ──
# define GE_WG_PORT  = 51820
# define NL_WG_PORT  = 51830

# ── Web UI amnezia-wg-easy: TCP (раскомментировать при необходимости) ──
# define GE_WEBUI_PORT = 51821
# define NL_WEBUI_PORT = 51831

table ip filter {

    # ─── Геолокация / ASN ───────────────────────────────────────────────

    # TG-список
    include "/opt/maxmind/list/tg/geoip-def-tg.nft"
    include "/opt/maxmind/list/tg/geoip-ipv4.nft"

    # RKN blacklist
    include "/opt/maxmind/list/rkn/geoip-def-rkn.nft"
    include "/opt/maxmind/list/rkn/geoip-ipv4.nft"

    # ASN-список
    include "/opt/maxmind/list/asn_nft/geoip-def-asn.nft"
    include "/opt/maxmind/list/asn_nft/geoip-ipv4.nft"

    # ─── Именованные наборы ─────────────────────────────────────────────

    # Зарубежные серверы назначения (для FORWARD-правил)
    set relay_targets {
        type ipv4_addr
        elements = { $SERVER_GE, $SERVER_NL }
    }

    # Все внутренние подсети (для анти-спуфинга)
    set private_nets {
        type ipv4_addr
        flags interval
        elements = {
            10.0.0.0/8,
            172.16.0.0/12,
            192.168.0.0/16
        }
    }

    # ─── Маркировка по GeoIP/ASN (input) ───────────────────────────────
    chain geoip-mark-input {
        type filter hook input priority -1; policy accept;
        meta mark set ip saddr map @tg
        meta mark set ip saddr map @asn
        meta mark set ip saddr map @rkn
    }

    # ─── Маркировка по GeoIP/ASN (forward) ─────────────────────────────
    chain geoip-mark-forward {
        type filter hook forward priority -1; policy accept;
        meta mark set ip saddr map @tg
        meta mark set ip saddr map @asn
        meta mark set ip saddr map @rkn
    }

    # ─── INPUT ──────────────────────────────────────────────────────────
    chain input {
        type filter hook input priority 0; policy drop;

        # ── Быстрый путь ──
        ct state established,related counter accept
        ct state invalid counter drop

        # Loopback
        iifname "lo" counter accept

        # ── Анти-спуфинг: приватные/bogon IP не должны приходить извне ──
        iifname != "lo" ip saddr 127.0.0.0/8 log prefix "INPUT-SPOOF: " level warn limit rate 5/second counter drop
        iifname != "lo" ip saddr @private_nets log prefix "INPUT-BOGON: " level warn limit rate 5/second counter drop
        ip saddr 0.0.0.0/8 counter drop
        ip saddr 169.254.0.0/16 counter drop
        ip saddr 224.0.0.0/4 counter drop
        ip saddr 240.0.0.0/4 counter drop

        # ── Защита от TCP-сканирования ──
        tcp flags & (fin|syn|rst|psh|ack|urg) == 0 counter drop
        tcp flags & (fin|syn) == (fin|syn) counter drop
        tcp flags & (syn|rst) == (syn|rst) counter drop
        tcp flags & (fin|rst) == (fin|rst) counter drop
        tcp flags & (fin|psh|urg) == (fin|psh|urg) counter drop
        tcp flags & (ack|urg) == urg counter drop

        # ── Защита от фрагментированных пакетов ──
        ip frag-off & 0x1fff != 0 counter drop

        # ── RKN Blacklist ──
        meta mark $BLACKLIST log prefix "IPTABLES-RK: " counter drop

        # ── SYN rate-limit INPUT ──
        tcp flags syn ct state new meter input_syn_meter { ip saddr limit rate over 30/second burst 20 packets } log prefix "INPUT-SYNFLOOD: " level warn counter drop

        # ── Аварийный SSH ──
        # Раскомментировать и указать свой IP, если потеряли доступ:
#        ip saddr { 195.18.16.0/22, 193.107.112.0/22, 91.205.216.0/22, 91.205.157.0/24 } tcp dport 9394 counter accept

        # ── ASN — SSH ──
        meta mark $ASN tcp dport 9394 log prefix "INPUT-SSH: " level info limit rate 10/second
        meta mark $ASN tcp dport 9394 counter accept

        # ── Port-scan rate-limit ──
        tcp flags syn ct state new meter port_scan_meter { ip saddr limit rate over 15/second burst 10 packets } log prefix "INPUT-PORTSCAN: " level warn counter drop

        # ICMP
        ip protocol icmp icmp type echo-reply limit rate 15/second counter accept
        ip protocol icmp drop

        # Запрет протоколов 41 (6in4), 47 (GRE), 4 (IPIP)
        ip protocol { 41, 47, 4 } drop

        # Логируем и дропаем остальное
        log prefix "INPUT-DROP: " level warn limit rate 10/second counter drop
    }

    # ─── FORWARD (NAT-релей + ASN фильтрация) ──────────────────────────
    chain forward {
        type filter hook forward priority 0; policy drop;

        # ── Быстрый путь ──
        ct state established,related counter accept
        ct state invalid counter drop

        # ── Защита от TCP-сканирования ──
        tcp flags & (fin|syn|rst|psh|ack|urg) == 0 counter drop
        tcp flags & (fin|syn) == (fin|syn) counter drop
        tcp flags & (syn|rst) == (syn|rst) counter drop
        tcp flags & (fin|rst) == (fin|rst) counter drop
        tcp flags & (fin|psh|urg) == (fin|psh|urg) counter drop
        tcp flags & (ack|urg) == urg counter drop

        # ── Защита от фрагментированных пакетов ──
        ip frag-off & 0x1fff != 0 counter drop

        # ── Анти-спуфинг ──
        fib saddr . iif oif missing log prefix "FWD-SPOOF: " level warn limit rate 5/second counter drop

        # ── RKN Blacklist: блокировка нежелательных IP ──
        meta mark $BLACKLIST ip daddr @relay_targets log prefix "RELAY-BL: " counter drop

        # ── Релей → 2-ge: VLESS/XRay (TCP 443) ──
        meta mark $ASN ip daddr $SERVER_GE tcp dport 443 log prefix "RELAY-GE-ASN: " level info limit rate 30/second
        meta mark $ASN ip daddr $SERVER_GE tcp dport 443 counter accept
        meta mark $TG ip daddr $SERVER_GE tcp dport 443 log prefix "RELAY-GE-TG: " level info limit rate 30/second
        meta mark $TG ip daddr $SERVER_GE tcp dport 443 counter accept

        # ── Релей → 3-nl: VLESS/XRay (TCP 443) ──
        meta mark $ASN ip daddr $SERVER_NL tcp dport 443 log prefix "RELAY-NL-ASN: " level info limit rate 30/second
        meta mark $ASN ip daddr $SERVER_NL tcp dport 443 counter accept
        meta mark $TG ip daddr $SERVER_NL tcp dport 443 log prefix "RELAY-NL-TG: " level info limit rate 30/second
        meta mark $TG ip daddr $SERVER_NL tcp dport 443 counter accept

        # ── Релей → 2-ge: MTProto (TCP 4443) ──
        meta mark $ASN ip daddr $SERVER_GE tcp dport 4443 log prefix "RELAY-GE-MTP-ASN: " level info limit rate 30/second
        meta mark $ASN ip daddr $SERVER_GE tcp dport 4443 counter accept
        meta mark $TG ip daddr $SERVER_GE tcp dport 4443 log prefix "RELAY-GE-MTP-TG: " level info limit rate 30/second
        meta mark $TG ip daddr $SERVER_GE tcp dport 4443 counter accept

        # ── Релей → 3-nl: MTProto (TCP 4443) ──
        meta mark $ASN ip daddr $SERVER_NL tcp dport 4443 log prefix "RELAY-NL-MTP-ASN: " level info limit rate 30/second
        meta mark $ASN ip daddr $SERVER_NL tcp dport 4443 counter accept
        meta mark $TG ip daddr $SERVER_NL tcp dport 4443 log prefix "RELAY-NL-MTP-TG: " level info limit rate 30/second
        meta mark $TG ip daddr $SERVER_NL tcp dport 4443 counter accept

        # ── Релей → 2-ge: AmneziaWG (UDP) — раскомментировать ──
#        meta mark $ASN ip daddr $SERVER_GE udp dport $GE_WG_PORT log prefix "RELAY-GE-WG-ASN: " level info limit rate 30/second
#        meta mark $ASN ip daddr $SERVER_GE udp dport $GE_WG_PORT counter accept
#        meta mark $TG ip daddr $SERVER_GE udp dport $GE_WG_PORT log prefix "RELAY-GE-WG-TG: " level info limit rate 30/second
#        meta mark $TG ip daddr $SERVER_GE udp dport $GE_WG_PORT counter accept

        # ── Релей → 3-nl: AmneziaWG (UDP) — раскомментировать ──
#        meta mark $ASN ip daddr $SERVER_NL udp dport $NL_WG_PORT log prefix "RELAY-NL-WG-ASN: " level info limit rate 30/second
#        meta mark $ASN ip daddr $SERVER_NL udp dport $NL_WG_PORT counter accept
#        meta mark $TG ip daddr $SERVER_NL udp dport $NL_WG_PORT log prefix "RELAY-NL-WG-TG: " level info limit rate 30/second
#        meta mark $TG ip daddr $SERVER_NL udp dport $NL_WG_PORT counter accept

        # ── Релей → 2-ge: Web UI (TCP) — раскомментировать ──
#        meta mark $ASN ip daddr $SERVER_GE tcp dport $GE_WEBUI_PORT log prefix "RELAY-GE-WEB: " level info limit rate 10/second
#        meta mark $ASN ip daddr $SERVER_GE tcp dport $GE_WEBUI_PORT counter accept

        # ── Релей → 3-nl: Web UI (TCP) — раскомментировать ──
#        meta mark $ASN ip daddr $SERVER_NL tcp dport $NL_WEBUI_PORT log prefix "RELAY-NL-WEB: " level info limit rate 10/second
#        meta mark $ASN ip daddr $SERVER_NL tcp dport $NL_WEBUI_PORT counter accept

        # ── SYN rate-limit per-source (после ASN/TG accept) ──
        tcp flags syn ct state new meter fwd_syn_meter { ip saddr limit rate over 30/second burst 20 packets } log prefix "FWD-SYNFLOOD: " level warn counter drop

        # Логируем дроп
        log prefix "FORWARD-DROP: " level warn limit rate 10/second counter drop
    }

    # ─── OUTPUT ─────────────────────────────────────────────────────────
    chain output {
        type filter hook output priority 0; policy accept;
    }
}

# ─── NAT: DNAT + Masquerade ────────────────────────────────────────────
table ip relay_nat {

    # ── DNAT: подмена destination на зарубежные серверы ──
    # fib daddr type local = только трафик, адресованный этому хосту.
    # Без этого транзитный трафик тоже будет перехвачен!
    chain prerouting {
        type nat hook prerouting priority -100;

        # ── VLESS/XRay → 2-ge (TCP 443 → 22.22.22.22:443) ──
        fib daddr type local tcp dport $GE_TCP_PORT dnat to $SERVER_GE:443

        # ── VLESS/XRay → 3-nl (TCP 8443 → 33.33.33.33:443) ──
        # Клиент подключается к 1-ru:8443, трафик уходит на 3-nl:443
        fib daddr type local tcp dport $NL_TCP_PORT dnat to $SERVER_NL:443

        # ── MTProto → 2-ge (TCP 4443 → 22.22.22.22:4443) ──
        fib daddr type local tcp dport $GE_MTPROTO_PORT dnat to $SERVER_GE:4443

        # ── MTProto → 3-nl (TCP 4444 → 33.33.33.33:4443) ──
        # Клиент подключается к 1-ru:4444, трафик уходит на 3-nl:4443
        fib daddr type local tcp dport $NL_MTPROTO_PORT dnat to $SERVER_NL:4443

        # ── AmneziaWG → 2-ge (UDP) — раскомментировать ──
#        fib daddr type local udp dport $GE_WG_PORT dnat to $SERVER_GE:$GE_WG_PORT

        # ── AmneziaWG → 3-nl (UDP) — раскомментировать ──
#        fib daddr type local udp dport $NL_WG_PORT dnat to $SERVER_NL:$NL_WG_PORT

        # ── Web UI → 2-ge (TCP) — раскомментировать ──
#        fib daddr type local tcp dport $GE_WEBUI_PORT dnat to $SERVER_GE:$GE_WEBUI_PORT

        # ── Web UI → 3-nl (TCP) — раскомментировать ──
#        fib daddr type local tcp dport $NL_WEBUI_PORT dnat to $SERVER_NL:$NL_WEBUI_PORT
    }

    # ── Masquerade: зарубежный сервер видит IP 1-ru, не клиента ──
    chain postrouting {
        type nat hook postrouting priority 100;

        # Маскировать трафик к зарубежным серверам
        ip daddr $SERVER_GE masquerade
        ip daddr $SERVER_NL masquerade
    }
}
