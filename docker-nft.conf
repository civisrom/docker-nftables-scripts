#!/usr/sbin/nft -f
#
# nftables rules for Docker (manual mode, iptables=false)
#
# Prerequisites:
#   1. Disable Docker's built-in iptables management:
#      /etc/docker/daemon.json: { "iptables": false }
#      Or: dockerd --iptables=false
#
#   2. Enable IP forwarding:
#      sysctl -w net.ipv4.ip_forward=1
#      Persistent: echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.d/docker.conf
#
# Usage:
#   nft -f docker-nft.conf
#
# To publish a port (e.g. host:8080 -> container:80):
#   Add to "chain docker" in inet docker table:
#     iif != $DOCKER_IF tcp dport 8080 accept
#   Add to "chain docker" in ip dockernat table:
#     tcp dport 8080 dnat to 172.17.0.2:80
#
# For custom Docker networks, duplicate the relevant rules
# replacing docker0/$DOCKER_NET with your bridge name/subnet.

define DOCKER_IF = docker0
define DOCKER_NET = 172.17.0.0/16

# Clean up existing tables to allow safe reload
table inet docker
delete table inet docker

table ip dockernat
delete table ip dockernat

table inet docker {
  chain forward {
    type filter hook forward priority 0; policy drop;

    # User-defined rules — add custom forwarding rules here
    jump docker-user

    # Container isolation between Docker networks
    jump docker-isolation-stage-1

    # Allow return traffic (established/related) to containers
    oif $DOCKER_IF ct state { established, related } accept

    # Published ports — accept rules for exposed services
    oif $DOCKER_IF jump docker

    # Allow containers to reach external networks (internet)
    iif $DOCKER_IF oif != $DOCKER_IF accept

    # Allow inter-container communication on the same bridge
    iif $DOCKER_IF oif $DOCKER_IF accept
  }

  chain output {
    type filter hook output priority 0;
    # Allow traffic to container veth interfaces
    meta oifkind "veth" accept
  }

  # Published port accept rules go here
  chain docker {
  }

  chain docker-isolation-stage-1 {
    iif $DOCKER_IF oif != $DOCKER_IF jump docker-isolation-stage-2
    return
  }

  chain docker-isolation-stage-2 {
    oif $DOCKER_IF drop
    return
  }

  # User chain — add custom rules here (e.g. restrict container access)
  # Example: block containers from reaching 10.0.0.0/8
  #   ip daddr 10.0.0.0/8 iif $DOCKER_IF drop
  chain docker-user {
    return
  }
}

table ip dockernat {
  chain prerouting {
    type nat hook prerouting priority -100;
    fib daddr type local jump docker
  }

  chain output {
    type nat hook output priority -100;
    ip daddr != 127.0.0.0/8 fib daddr type local jump docker
  }

  chain postrouting {
    type nat hook postrouting priority 100;
    oif != $DOCKER_IF ip saddr $DOCKER_NET masquerade
  }

  # DNAT rules for published ports go here
  chain docker {
    iif $DOCKER_IF return
  }
}
