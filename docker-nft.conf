#!/usr/sbin/nft -f
#
# nftables конфиг: хост nginx (443) + Docker mtproto (4443) + WireGuard (51820/51821)
#
# Требования:
#   1. Docker: /etc/docker/daemon.json: { "iptables": false }
#   2. sysctl:
#      net.ipv4.ip_forward = 1
#      net.ipv4.conf.all.rp_filter = 1
#      net.ipv4.conf.default.rp_filter = 1
#
# Схема сети:
#   HOST:           nginx (reverse proxy для 3x-ui) — порт 443
#   Docker mtproto: 172.18.0.2 — порт 4443
#   Docker WG:      10.8.0.2 — порт 51820 (WireGuard)
#   Docker WG1:     10.8.0.3 — порт 51821 (WireGuard)
#   Docker build:   172.17.0.0/16 (docker0, временные контейнеры)

# Очищаем существующие правила
flush ruleset

# ─── Адреса контейнеров ────────────────────────────────────────────────
define MTPROTO_IP   = 172.18.0.2
# ВАЖНО: проверьте IP через docker inspect <wg-container> | grep IPAddress
define WG_IP        = 10.8.0.2
define WG1_IP       = 10.8.0.3

# ─── Порты WireGuard ──────────────────────────────────────────────────
define WGPORT       = 51820
define WG1PORT      = 51821

table ip filter {

    # ─── Геолокация / ASN ───────────────────────────────────────────────

    # TG-список
    include "/opt/maxmind/list/tg/geoip-def-tg.nft"
    include "/opt/maxmind/list/tg/geoip-ipv4.nft"

    # RKN blacklist
    include "/opt/maxmind/list/rkn/geoip-def-rkn.nft"
    include "/opt/maxmind/list/rkn/geoip-ipv4.nft"

    # ASN-список
    include "/opt/maxmind/list/asn_nft/geoip-def-asn.nft"
    include "/opt/maxmind/list/asn_nft/geoip-ipv4.nft"

    # ─── Именованные наборы ─────────────────────────────────────────────

    # Docker-подсети (mtproto + WireGuard)
    set docker_nets {
        type ipv4_addr
        flags interval
        elements = { 172.18.0.0/16, 10.8.0.0/24 }
    }

    # Все внутренние подсети (для анти-спуфинга)
    set private_nets {
        type ipv4_addr
        flags interval
        elements = {
            10.0.0.0/8,
            172.16.0.0/12,
            192.168.0.0/16
        }
    }

    # ─── Маркировка по GeoIP/ASN (input) ───────────────────────────────
    chain geoip-mark-input {
        type filter hook input priority -1; policy accept;
        meta mark set ip saddr map @tg
        meta mark set ip saddr map @asn
        meta mark set ip saddr map @rkn
    }

    # ─── Маркировка по GeoIP/ASN (forward) ─────────────────────────────
    chain geoip-mark-forward {
        type filter hook forward priority -1; policy accept;
        meta mark set ip saddr map @tg
        meta mark set ip saddr map @asn
        meta mark set ip saddr map @rkn
    }

    # ─── INPUT ──────────────────────────────────────────────────────────
    chain input {
        type filter hook input priority 0; policy drop;

        # ── Быстрый путь: established/related первыми (производительность) ──
        ct state established,related counter accept
        ct state invalid counter drop

        # Loopback
        iifname "lo" counter accept

        # ── Трафик от Docker-контейнеров к хосту ──
        # ВАЖНО: до bogon-фильтра! Контейнеры (172.18.0.x) попадают под @private_nets
        ip saddr @docker_nets counter accept

        # ── Анти-спуфинг: приватные/bogon IP не должны приходить извне ──
        iifname != "lo" ip saddr 127.0.0.0/8 counter drop
        iifname != "lo" ip saddr @private_nets counter drop
        ip saddr 0.0.0.0/8 counter drop
        ip saddr 169.254.0.0/16 counter drop
        ip saddr 224.0.0.0/4 counter drop
        ip saddr 240.0.0.0/4 counter drop

        # ── Защита от TCP-сканирования (XMAS, NULL, invalid flags) ──
        tcp flags & (fin|syn|rst|psh|ack|urg) == 0 counter drop
        tcp flags & (fin|syn) == (fin|syn) counter drop
        tcp flags & (syn|rst) == (syn|rst) counter drop
        tcp flags & (fin|rst) == (fin|rst) counter drop
        tcp flags & (fin|psh|urg) == (fin|psh|urg) counter drop
        tcp flags & (ack|urg) == urg counter drop

        # ── Защита от фрагментированных пакетов ──
        ip frag-off & 0x1fff != 0 counter drop

        # ── RKN Blacklist ──
        meta mark $BLACKLIST log prefix "IPTABLES-RK: " counter drop

        # ── SYN rate-limit INPUT: защита хоста от SYN-flood ──
        tcp flags syn ct state new meter input_syn_meter { ip saddr limit rate over 30/second burst 20 packets } log prefix "INPUT-SYNFLOOD: " level warn counter drop

        # ── Аварийный SSH: доступ ВСЕГДА, даже если ASN-списки сломаны ──
        # Раскомментировать и указать свой IP/подсети, если потеряли доступ:
#        ip saddr { 195.18.16.0/22, 193.107.112.0/22, 91.205.216.0/22, 91.205.157.0/24 } tcp dport 9394 counter accept

        # ── ASN — разрешённые порты хоста ──
        # 443 = nginx reverse proxy (3x-ui), 9394 = SSH
        meta mark $ASN tcp dport { 443, 9394 } counter accept
        # WireGuard UDP от разрешённых ASN
        meta mark $ASN udp dport { $WGPORT, $WG1PORT } counter accept

        # ── TG — порт 443 (для TG-клиентов, если нужен доступ к панели) ──
        meta mark $TG tcp dport 443 counter accept

        # ── Port-scan rate-limit: замедляет сканирование портов ──
        tcp flags syn ct state new meter port_scan_meter { ip saddr limit rate over 15/second burst 10 packets } log prefix "INPUT-PORTSCAN: " level warn counter drop

        # ICMP
        ip protocol icmp icmp type echo-reply limit rate 15/second counter accept
        ip protocol icmp drop

        # Запрет протоколов 41 (6in4), 47 (GRE), 4 (IPIP)
        ip protocol { 41, 47, 4 } drop

        # Логируем и дропаем остальное
        log prefix "INPUT-DROP: " level warn limit rate 10/second counter drop
    }

    # ─── FORWARD (Docker + ASN фильтрация) ─────────────────────────────
    chain forward {
        type filter hook forward priority 0; policy drop;

        # ── Быстрый путь ──
        ct state established,related counter accept
        ct state invalid counter drop

        # ── Защита от TCP-сканирования (XMAS, NULL, invalid flags) ──
        tcp flags & (fin|syn|rst|psh|ack|urg) == 0 counter drop
        tcp flags & (fin|syn) == (fin|syn) counter drop
        tcp flags & (syn|rst) == (syn|rst) counter drop
        tcp flags & (fin|rst) == (fin|rst) counter drop
        tcp flags & (fin|psh|urg) == (fin|psh|urg) counter drop
        tcp flags & (ack|urg) == urg counter drop

        # ── Защита от фрагментированных пакетов ──
        ip frag-off & 0x1fff != 0 counter drop

        # ── Анти-спуфинг ──
        fib saddr . iif oif missing counter drop

        # ── Внутренний трафик Docker (между подсетями) ──
        ip saddr @docker_nets ip daddr @docker_nets log prefix "FWD-DOCKER: " level info limit rate 30/second
        ip saddr @docker_nets ip daddr @docker_nets counter accept

        # ── Контейнеры → интернет (mtproto, WG нужен исходящий доступ) ──
        ip saddr @docker_nets log prefix "FWD-INET: " level info limit rate 30/second
        ip saddr @docker_nets counter accept

        # ── Docker build: default bridge (docker0, 172.17.0.0/16) → интернет ──
        iifname "docker0" counter accept

        # ── Снаружи → контейнеры (GeoIP/ASN фильтрация) ──
        meta mark $BLACKLIST ip daddr @docker_nets log prefix "DOCKER-BL: " counter drop
        meta mark $TG ip daddr @docker_nets log prefix "FWD-TG: " level info limit rate 30/second
        meta mark $TG ip daddr @docker_nets counter accept
        meta mark $ASN ip daddr @docker_nets log prefix "FWD-ASN: " level info limit rate 30/second
        meta mark $ASN ip daddr @docker_nets counter accept

        # ── SYN rate-limit per-source: защита от SYN-flood ──
        # Расположено ПОСЛЕ ASN/TG accept — доверенный трафик уже пропущен.
        tcp flags syn ct state new meter fwd_syn_meter { ip saddr limit rate over 30/second burst 20 packets } log prefix "FWD-SYNFLOOD: " level warn counter drop

        # Логируем дроп
        log prefix "FORWARD-DROP: " level warn limit rate 10/second counter drop
    }

    # ─── OUTPUT ─────────────────────────────────────────────────────────
    chain output {
        type filter hook output priority 0; policy accept;
    }
}

# ─── Docker NAT ─────────────────────────────────────────────────────────
table ip dockernat {

    # ── DNAT: проброс портов к контейнерам ──
    # fib daddr type local = только трафик адресованный хосту
    # Порт 443 НЕ пробрасывается — nginx работает на хосте!
    chain prerouting {
        type nat hook prerouting priority -100;

        # MTProto
        fib daddr type local tcp dport 4443 dnat to $MTPROTO_IP:4443

        # WireGuard
        fib daddr type local udp dport $WGPORT dnat to $WG_IP:$WGPORT
        fib daddr type local udp dport $WG1PORT dnat to $WG1_IP:$WG1PORT
    }

    # ── Masquerade: контейнеры → интернет ──
    chain postrouting {
        type nat hook postrouting priority 100;

        # Не маскировать внутренний трафик Docker (WG ↔ другие контейнеры)
        ip saddr 10.8.0.0/24 ip daddr @docker_nets return

        # mtproto (172.18.0.0/16)
        ip saddr 172.18.0.0/16 masquerade

        # WireGuard (10.8.0.0/24)
        ip saddr 10.8.0.0/24 masquerade

        # Docker build: default bridge
        ip saddr 172.17.0.0/16 masquerade
    }
}
