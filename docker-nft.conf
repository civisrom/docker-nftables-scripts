#!/usr/sbin/nft -f
#
# Интегрированный конфиг nftables + vpnbot (Docker)
#
# Требования:
#   1. Docker: /etc/docker/daemon.json: { "iptables": false }
#   2. sysctl:
#      net.ipv4.ip_forward = 1
#      net.ipv4.conf.all.rp_filter = 1
#      net.ipv4.conf.default.rp_filter = 1
#
# vpnbot docker-compose.yml определяет:
#   Сеть default:  10.10.0.0/24 (все контейнеры)
#   Сеть xray:     10.10.1.0/24 (nginx ↔ xray)
#   VPN-клиенты:   10.0.1.0/24 (WG), 10.0.2.0/24 (OC), 10.0.3.0/24 (WG1)

# Очищаем существующие правила
flush ruleset

# ─── vpnbot: адреса контейнеров (из docker-compose.yml) ──────────────
define UPSTREAM_IP  = 10.10.0.10
define NGINX_IP     = 10.10.0.2
define WG_IP        = 10.10.0.4
define WG1_IP       = 10.10.0.14
define ADGUARD_IP   = 10.10.0.5
define MTPROTO_IP   = 10.10.0.8
define DNSTT_IP     = 10.10.0.16
define SS_IP        = 10.10.0.6
define HYSTERIA_IP  = 10.10.0.17

# ─── vpnbot: порты (из .env) ─────────────────────────────────────────
define WGPORT       = 51820
define WG1PORT      = 51821

table ip filter {

    # ─── Геолокация / ASN ───────────────────────────────────────────────

    # TG-список (пути к файлам скорректируйте под вашу структуру)
    include "/opt/maxmind/list/tg/geoip-def-tg.nft"
    include "/opt/maxmind/list/tg/geoip-ipv4.nft"

    # ASN-список
    include "/opt/maxmind/list/asn_nft/geoip-def-asn.nft"
    include "/opt/maxmind/list/asn_nft/geoip-ipv4.nft"

#    include "/opt/maxmind/list/nftables/drop/geoip-def-ruasndrop.nft"
#    include "/opt/maxmind/list/nftables/drop/geoip-ipv4.nft"

    # ─── Именованные наборы ─────────────────────────────────────────────

    # DNS-серверы (upstream для AdGuard и контейнеров)
    set dns_servers {
        type ipv4_addr
        elements = { 8.8.8.8, 1.1.1.1, 8.8.4.4, 1.0.0.1 }
    }

    # Docker-подсети vpnbot
    set docker_nets {
        type ipv4_addr
        flags interval
        elements = { 10.10.0.0/24, 10.10.1.0/24 }
    }

    # Подсети VPN-клиентов (WG, OC, WG1)
    set vpn_clients {
        type ipv4_addr
        flags interval
        elements = { 10.0.1.0/24, 10.0.2.0/24, 10.0.3.0/24 }
    }

    # Все внутренние подсети (для анти-спуфинга)
    set private_nets {
        type ipv4_addr
        flags interval
        elements = {
            10.0.0.0/8,
            172.16.0.0/12,
            192.168.0.0/16
        }
    }

    # ─── Маркировка по GeoIP/ASN (input) ───────────────────────────────
    chain geoip-mark-input {
        type filter hook input priority -1; policy accept;
        meta mark set ip saddr map @tg
        meta mark set ip saddr map @asn
    }

    # ─── Маркировка по GeoIP/ASN (forward) ─────────────────────────────
    chain geoip-mark-forward {
        type filter hook forward priority -1; policy accept;
        meta mark set ip saddr map @tg
        meta mark set ip saddr map @asn
    }

    # ─── INPUT ──────────────────────────────────────────────────────────
    chain input {
        type filter hook input priority 0; policy drop;

        # ── Быстрый путь: established/related первыми (производительность) ──
        ct state established,related counter accept
        ct state invalid counter drop

        # Loopback
        iifname "lo" counter accept

        # ── vpnbot: трафик от Docker-контейнеров к хосту ──
        # ВАЖНО: до bogon-фильтра! Контейнеры (10.10.0.x) попадают под @private_nets
        ip saddr @docker_nets counter accept
        ip saddr @vpn_clients counter accept

        # ── Анти-спуфинг: приватные/bogon IP не должны приходить извне ──
        # ПОСЛЕ docker_nets — иначе контейнерный трафик дропается
        iifname != "lo" ip saddr 127.0.0.0/8 counter drop
        iifname != "lo" ip saddr @private_nets counter drop
        ip saddr 0.0.0.0/8 counter drop
        ip saddr 169.254.0.0/16 counter drop
        ip saddr 224.0.0.0/4 counter drop
        ip saddr 240.0.0.0/4 counter drop

        # ── Защита от TCP-сканирования (XMAS, NULL, invalid flags) ──
        tcp flags & (fin|syn|rst|psh|ack|urg) == 0 counter drop
        tcp flags & (fin|syn) == (fin|syn) counter drop
        tcp flags & (syn|rst) == (syn|rst) counter drop
        tcp flags & (fin|rst) == (fin|rst) counter drop
        tcp flags & (fin|psh|urg) == (fin|psh|urg) counter drop
        tcp flags & (ack|urg) == urg counter drop

        # ── Защита от фрагментированных пакетов ──
        ip frag-off & 0x1fff != 0 counter drop

        # ── Blacklist ──
#        meta mark $BLACKLIST log prefix "IPTABLES-RK: " counter drop

        # ── SYN rate-limit INPUT: защита хоста от SYN-flood ──
        # Per-source лимит — не мешает легитимным пользователям
        tcp flags syn ct state new meter input_syn_meter { ip saddr limit rate over 30/second burst 20 packets } log prefix "INPUT-SYNFLOOD: " level warn counter drop

        # ── Аварийный SSH: доступ ВСЕГДА, даже если ASN-списки сломаны ──
        # Раскомментировать и указать свой IP, если потеряли доступ:
#        ip saddr YOUR.IP.HERE tcp dport 9394 counter accept

        # ── ASN — разрешённые порты хоста ──
        meta mark $ASN tcp dport { 53, 443, 853, 8388, 9394 } counter accept
        meta mark $ASN udp dport { 53, 443, 8388, 8443 } counter accept

        # ── vpnbot: WireGuard UDP от разрешённых ASN ──
        meta mark $ASN udp dport $WGPORT counter accept
        meta mark $ASN udp dport $WG1PORT counter accept

        # ── RustDesk (network_mode: host) от разрешённых ASN ──
        meta mark $ASN tcp dport { 21115, 21116, 21117 } counter accept
        meta mark $ASN udp dport 21116 counter accept

        # ── Port-scan rate-limit: замедляет сканирование портов ──
        tcp flags syn ct state new meter port_scan_meter { ip saddr limit rate over 15/second burst 10 packets } log prefix "INPUT-PORTSCAN: " level warn counter drop

        # ICMP
        ip protocol icmp icmp type echo-reply limit rate 15/second counter accept
        ip protocol icmp drop

        # Запрет протоколов 41 (6in4), 47 (GRE), 4 (IPIP)
        ip protocol { 41, 47, 4 } drop

        # Логируем и дропаем остальное
        log prefix "INPUT-DROP: " level warn limit rate 10/second counter drop
    }

    # ─── FORWARD (Docker + ASN фильтрация) ─────────────────────────────
    chain forward {
        type filter hook forward priority 0; policy drop;

        # ── Быстрый путь ──
        ct state established,related counter accept
        ct state invalid counter drop

        # ── Защита от TCP-сканирования (XMAS, NULL, invalid flags) ──
        tcp flags & (fin|syn|rst|psh|ack|urg) == 0 counter drop
        tcp flags & (fin|syn) == (fin|syn) counter drop
        tcp flags & (syn|rst) == (syn|rst) counter drop
        tcp flags & (fin|rst) == (fin|rst) counter drop
        tcp flags & (fin|psh|urg) == (fin|psh|urg) counter drop
        tcp flags & (ack|urg) == urg counter drop

        # ── Защита от фрагментированных пакетов ──
        ip frag-off & 0x1fff != 0 counter drop

        # ── Анти-спуфинг: приватные src IP только от Docker-бриджей ──
        # Пакет с src=10.10.0.x должен приходить от Docker-бриджа,
        # а не от внешнего интерфейса. fib проверяет, что src IP
        # маршрутизируется через тот же интерфейс, откуда пришёл пакет.
        fib saddr . iif oif missing counter drop

        # ── Внутренний трафик Docker ──
        # Контейнеры ↔ контейнеры (10.10.0.0/24, 10.10.1.0/24)
        ip saddr @docker_nets ip daddr @docker_nets log prefix "FWD-DOCKER: " level info limit rate 30/second
        ip saddr @docker_nets ip daddr @docker_nets counter accept

        # Трафик VPN-клиентов ↔ Docker-контейнеры
        ip saddr @vpn_clients ip daddr @docker_nets log prefix "FWD-VPN-IN: " level info limit rate 30/second
        ip saddr @vpn_clients ip daddr @docker_nets counter accept
        ip saddr @docker_nets ip daddr @vpn_clients log prefix "FWD-VPN-OUT: " level info limit rate 30/second
        ip saddr @docker_nets ip daddr @vpn_clients counter accept

        # ── Контейнеры → DNS (для AdGuard upstream, DoH) ──
        ip saddr @docker_nets ip daddr @dns_servers udp dport 53 log prefix "FWD-DNS: " level info limit rate 10/second
        ip saddr @docker_nets ip daddr @dns_servers udp dport 53 counter accept
        ip saddr @docker_nets ip daddr @dns_servers tcp dport { 53, 443 } log prefix "FWD-DNS: " level info limit rate 10/second
        ip saddr @docker_nets ip daddr @dns_servers tcp dport { 53, 443 } counter accept
        ip saddr @docker_nets ip daddr @dns_servers udp dport 443 log prefix "FWD-DOH: " level info limit rate 10/second
        ip saddr @docker_nets ip daddr @dns_servers udp dport 443 counter accept

        # ── VPN-маршрутизация: контейнеры → интернет ──
        ip saddr @docker_nets log prefix "FWD-INET: " level info limit rate 30/second
        ip saddr @docker_nets counter accept

        # ── Docker build: default bridge (docker0, 172.17.0.0/16) → интернет ──
        # Временные контейнеры при docker build используют стандартный бридж,
        # не кастомные сети vpnbot. Без этого правила build не может резолвить DNS.
        iifname "docker0" counter accept

        # ── Снаружи → контейнеры (ASN фильтрация) ──
#        meta mark $BLACKLIST ip daddr @docker_nets log prefix "DOCKER-BL: " counter drop
        meta mark $ASN ip daddr @docker_nets log prefix "FWD-ASN: " level info limit rate 30/second
        meta mark $ASN ip daddr @docker_nets counter accept
        meta mark $TG ip daddr @docker_nets log prefix "FWD-TG: " level info limit rate 30/second
        meta mark $TG ip daddr @docker_nets counter accept

        # ── Временно: порты открыты для всех (без ASN) ──
        ip daddr $NGINX_IP tcp dport 80 counter accept
#        ip daddr $DNSTT_IP tcp dport 53 counter accept
#        ip daddr $DNSTT_IP udp dport 53 counter accept
#        ip daddr $SS_IP tcp dport 8388 counter accept
#        ip daddr $SS_IP udp dport 8388 counter accept
#        ip daddr $ADGUARD_IP tcp dport 853 counter accept
#        ip daddr $UPSTREAM_IP tcp dport 443 counter accept
#        ip daddr $UPSTREAM_IP udp dport 443 counter accept
#        ip daddr $HYSTERIA_IP udp dport 8443 counter accept
#        ip daddr $WG_IP udp dport $WGPORT counter accept
#        ip daddr $WG1_IP udp dport $WG1PORT counter accept

        # ── SYN rate-limit per-source: защита от SYN-flood ──
        # Per-IP лимит — один атакующий не заблокирует трафик для других.
        # Расположено ПОСЛЕ ASN/TG accept — доверенный трафик уже пропущен.
        tcp flags syn ct state new meter fwd_syn_meter { ip saddr limit rate over 30/second burst 20 packets } log prefix "FWD-SYNFLOOD: " level warn counter drop

        # Логируем дроп
        log prefix "FORWARD-DROP: " level warn limit rate 10/second counter drop
    }

    # ─── OUTPUT ─────────────────────────────────────────────────────────
    chain output {
        type filter hook output priority 0; policy accept;
    }
}

# ─── Docker NAT (vpnbot) ───────────────────────────────────────────────
table ip dockernat {

    # ── DNAT: проброс портов к контейнерам ──
    # fib daddr type local = только трафик адресованный хосту (входящий извне).
    chain prerouting {
        type nat hook prerouting priority -100;

        # HTTP → nginx
        fib daddr type local tcp dport 80 dnat to $NGINX_IP:80

        # HTTPS/QUIC → upstream (SNI-маршрутизация к xray, oc, naive, nginx)
        fib daddr type local tcp dport 443 dnat to $UPSTREAM_IP:443
        fib daddr type local udp dport 443 dnat to $UPSTREAM_IP:443

        # MTProto
        fib daddr type local tcp dport 4443 dnat to $MTPROTO_IP:4443

        # dnstt (DNS-туннель)
        fib daddr type local tcp dport 53 dnat to $DNSTT_IP:53
        fib daddr type local udp dport 53 dnat to $DNSTT_IP:53

        # Shadowsocks
        fib daddr type local tcp dport 8388 dnat to $SS_IP:8388
        fib daddr type local udp dport 8388 dnat to $SS_IP:8388

        # AdGuard DoT (DNS-over-TLS)
        fib daddr type local tcp dport 853 dnat to $ADGUARD_IP:853

        # Hysteria
        fib daddr type local udp dport 8443 dnat to $HYSTERIA_IP:8443

        # WireGuard
        fib daddr type local udp dport $WGPORT dnat to $WG_IP:$WGPORT
        fib daddr type local udp dport $WG1PORT dnat to $WG1_IP:$WG1PORT
    }

    chain output {
        type nat hook output priority -100;
        ip daddr != 127.0.0.0/8 fib daddr type local tcp dport 80 dnat to $NGINX_IP:80
        ip daddr != 127.0.0.0/8 fib daddr type local tcp dport 443 dnat to $UPSTREAM_IP:443
        ip daddr != 127.0.0.0/8 fib daddr type local udp dport 443 dnat to $UPSTREAM_IP:443
    }

    # ── Masquerade: контейнеры → интернет ──
    chain postrouting {
        type nat hook postrouting priority 100;

        # Не маскировать внутренний трафик Docker (между подсетями)
        ip saddr 10.10.0.0/24 ip daddr { 10.10.0.0/24, 10.10.1.0/24 } return
        ip saddr 10.10.1.0/24 ip daddr { 10.10.0.0/24, 10.10.1.0/24 } return

        # Не маскировать трафик к VPN-клиентам
        ip daddr { 10.0.1.0/24, 10.0.2.0/24, 10.0.3.0/24 } return

        # Трафик из Docker-подсетей → интернет (masquerade на внешний IP)
        ip saddr 10.10.0.0/24 masquerade
        ip saddr 10.10.1.0/24 masquerade

        # Docker build: default bridge
        ip saddr 172.17.0.0/16 masquerade
    }
}
