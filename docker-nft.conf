#!/usr/sbin/nft -f
#
# Интегрированный конфиг nftables + Docker
#
# Требования:
#   1. Docker: /etc/docker/daemon.json: { "iptables": false }
#   2. IP forwarding: sysctl -w net.ipv4.ip_forward=1
#
# Публикация порта (пример: host:8080 -> container:80):
#   В chain docker (table ip filter):
#     iifname != $DOCKER_IF tcp dport 8080 counter accept
#   В chain docker (table ip dockernat):
#     tcp dport 8080 dnat to 172.17.0.2:80

# Очищаем существующие правила
flush ruleset

# ─── Docker ───
define DOCKER_IF  = docker0
define DOCKER_NET = 172.17.0.0/16

table ip filter {

    # ─── Геолокация / ASN ───────────────────────────────────────────────
    include "/opt/maxmind/list/try/geoip-def-try.nft"
    include "/opt/maxmind/list/try/geoip-ipv4.nft"

    include "/opt/maxmind/list/asn_nft/geoip-def-asn.nft"
    include "/opt/maxmind/list/asn_nft/geoip-ipv4.nft"

#    include "/opt/maxmind/list/nftables/drop/geoip-def-ruasndrop.nft"
#    include "/opt/maxmind/list/nftables/drop/geoip-ipv4.nft"

#    include "/opt/maxmind/list/test/1/geoip-def-test.nft"
#    include "/opt/maxmind/list/test/1/geoip-ipv4.nft"

    # ─── DNS-серверы для контейнеров ────────────────────────────────────
    set dns_servers {
        type ipv4_addr
        elements = { 8.8.8.8, 1.1.1.1, 8.8.4.4, 1.0.0.1 }
    }

    # ─── Маркировка по GeoIP/ASN (input) ───────────────────────────────
    chain geoip-mark-input {
        type filter hook input priority -1; policy accept;
        meta mark set ip saddr map @try
        meta mark set ip saddr map @asn
    }

    # ─── Маркировка по GeoIP/ASN (forward) ─────────────────────────────
    chain geoip-mark-forward {
        type filter hook forward priority -1; policy accept;
        meta mark set ip saddr map @try
        meta mark set ip saddr map @asn
    }

    # ─── INPUT ──────────────────────────────────────────────────────────
    chain input {
        type filter hook input priority 0; policy drop;

        # Blacklist
        meta mark $BLACKLIST log prefix "IPTABLES-RK: " counter drop

        # ASN — разрешённые порты хоста
        meta mark $ASN tcp dport { 443, 22 } counter accept
        meta mark $ASN udp dport 443 counter accept

        # ICMP
        ip protocol icmp icmp type echo-reply limit rate 15/second counter accept
        ip protocol icmp drop

        # Запрет протоколов 41 (6in4), 47 (GRE), 4 (IPIP)
        ip protocol 41 drop
        ip protocol 47 drop
        ip protocol 4 drop

        # Базовые правила
        ct state { related, established } counter accept
        iifname "lo" counter accept

        # Docker: разрешаем трафик от контейнеров к хосту
        iifname $DOCKER_IF counter accept

        # Логируем и дропаем остальное
        log prefix "INPUT-DROP: " level warn limit rate 10/second counter drop
        tcp dport 1-65535 drop
        udp dport 1-65535 drop
    }

    # ─── FORWARD (Docker + ASN фильтрация) ─────────────────────────────
    chain forward {
        type filter hook forward priority 0; policy drop;

        # Пользовательские правила (добавляйте свои в docker-user)
        jump docker-user

        # Изоляция Docker-сетей
        jump docker-isolation-stage-1

        # Разрешить established/related (возвратный трафик)
        ct state { established, related } counter accept

        # ── Внутренний трафик Docker ──
        # Контейнеры на одном бридже
        iifname $DOCKER_IF oifname $DOCKER_IF counter accept
        # Трафик между Docker-сетями (10.0.0.0/8)
        ip saddr 10.0.0.0/8 ip daddr 10.0.0.0/8 counter accept

        # ── Контейнеры → наружу (только DNS) ──
        iifname $DOCKER_IF ip daddr @dns_servers udp dport 53 counter accept
        iifname $DOCKER_IF ip daddr @dns_servers tcp dport { 53, 443 } counter accept
        iifname $DOCKER_IF ip daddr @dns_servers udp dport 443 counter accept

        # ── Снаружи → контейнеры (ASN фильтрация) ──
        # Blacklist — блокируем
        meta mark $BLACKLIST oifname $DOCKER_IF log prefix "DOCKER-BL: " counter drop
        # ASN — разрешаем к опубликованным портам
        meta mark $ASN oifname $DOCKER_IF jump docker

        # Логируем дроп
        log prefix "FORWARD-DROP: " level warn limit rate 10/second counter drop
    }

    # ── Опубликованные порты контейнеров ──
    # Добавляйте правила сюда, пример:
    #   iifname != $DOCKER_IF tcp dport 8080 counter accept
    chain docker {
    }

    chain docker-isolation-stage-1 {
        iifname $DOCKER_IF oifname != $DOCKER_IF jump docker-isolation-stage-2
        return
    }

    chain docker-isolation-stage-2 {
        oifname $DOCKER_IF drop
        return
    }

    # Пользовательские правила форвардинга
    # Пример: заблокировать контейнерам доступ к LAN
    #   iifname $DOCKER_IF ip daddr 192.168.0.0/16 drop
    chain docker-user {
        return
    }

    # ─── OUTPUT ─────────────────────────────────────────────────────────
    chain output {
        type filter hook output priority 0; policy accept;
        oifname "lo" counter accept
        ct state established,related counter accept

        # Docker: разрешить трафик к veth-интерфейсам контейнеров
        meta oifkind "veth" accept

        ip protocol icmp icmp type echo-request counter accept

        log prefix "OUTPUT-DROP: " level warn limit rate 5/second counter drop
    }
}

# ─── Docker NAT ─────────────────────────────────────────────────────────
table ip dockernat {
    chain prerouting {
        type nat hook prerouting priority -100;
        fib daddr type local jump docker
    }

    chain output {
        type nat hook output priority -100;
        ip daddr != 127.0.0.0/8 fib daddr type local jump docker
    }

    chain postrouting {
        type nat hook postrouting priority 100;
        oifname != $DOCKER_IF ip saddr $DOCKER_NET masquerade
    }

    # DNAT для опубликованных портов
    # Пример: tcp dport 8080 dnat to 172.17.0.2:80
    chain docker {
        iifname $DOCKER_IF return
    }
}
