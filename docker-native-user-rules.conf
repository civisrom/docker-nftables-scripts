#!/usr/sbin/nft -f
#
# Custom user rules for Docker 29+ native nftables backend
# (firewall-backend=nftables)
#
# Docker 29+ manages its own tables (ip docker-bridges, ip6 docker-bridges).
# Do NOT modify Docker's tables directly â€” they are fully managed by Docker.
#
# Instead, create your own table with base chains at the same hook points.
# Use priority to control rule ordering relative to Docker's chains.
#
# Prerequisites:
#   /etc/docker/daemon.json:
#   {
#     "firewall-backend": "nftables"
#   }
#
#   Enable IP forwarding (Docker will NOT do this automatically with nftables):
#     sysctl -w net.ipv4.ip_forward=1
#     Persistent: echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.d/docker.conf
#
# Note: There is no DOCKER-USER chain in the native nftables backend.
# Use this table with appropriate priorities instead.
#
# To allow traffic that Docker would otherwise drop, use --bridge-accept-fwmark.
# Example in daemon.json: { "bridge-accept-fwmark": 1 }
# Then mark accepted packets with: meta mark set 1

table inet docker-user-rules
delete table inet docker-user-rules

table inet docker-user-rules {
  # Runs BEFORE Docker's forward chain (priority -1 < Docker's 0)
  chain forward-pre {
    type filter hook forward priority -1; policy accept;

    # Example: block containers from reaching internal LAN
    # iif "docker0" ip daddr 10.0.0.0/8 drop
    # iif "docker0" ip daddr 192.168.0.0/16 drop

    # Example: allow only specific container subnet to reach internet
    # iif "br-custom" accept
  }

  # Runs AFTER Docker's forward chain (priority 1 > Docker's 0)
  chain forward-post {
    type filter hook forward priority 1; policy accept;

    # Example: log forwarded Docker traffic
    # iif "docker0" log prefix "docker-fwd: " accept
  }
}
